# 实现对等连接冗余网络架构 {#task_1545758 .task}

为了保证单条物理专线出现故障时，可以顺利切换至冗余专线，您需要为每个VBR上连的对等连接配置健康检查和路由权重。

配置健康检查和路由权重前，您需要确保以下操作已完成：

-   确保您已经申请了两个物理专线接口，并且阿里云和本地IDC的物理专线网络已经连通。
-   确保您已经创建了两个从边界路由器到云上VPC的对等连接，详情请参见[自主申请专线接口](../intl.zh-CN/物理专线连接/自主申请专线接口.md#)和[VBR上联](../intl.zh-CN/专有网络对等连接（关闭新购）/VBR上联.md#)。
-   边界路由器和本地IDC之间配置的是静态路由配置，未使用BGP。

阿里云的每台XGW默认每两秒从健康检查IP地址向本地数据中心中的客户侧互联IP发送一个ping报文，如果某条物理专线上连续8个ping报文都无法得到回复，则将流量切换至另一条链路。

**说明：** 如果本地数据中心网络设备配置了Copp策略（如思科设备） 或者本机防攻击策略（如华为设备）可能会导致健康探测报文被丢弃，造成健康检查链路震荡，建议本地数据中心网络设备取消控制面限速配置。

![本地数据中心访问VPC](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654306_zh-CN.png)

网路拓扑信息如下：

|参数|地址段|
|--|---|
|互连的VPC|192.168.0.0/16|
|本地IDC|172.16.0.0/16|
|第一个VBR和IDC的互联地址| -   VBR网关IP：10.10.10.1
-   本地IDC网关IP：10.10.10.2
-   掩码：255.255.255.252

 |
|第二个VBR和IDC的互联地址| -   VBR网关IP：10.10.11.1
-   本地IDC网关IP：10.10.11.2
-   掩码：255.255.255.252

 |
|第一个对等连接健康检查| -   源IP：192.168.10.1
-   目的IP：10.10.10.2

 |
|第二个对等连接健康检查| -   源IP：192.168.10.2
-   目的IP：10.10.11.2

 |

## 步骤一 配置健康检查 {#section_02h_835_9ny .section}

您需要给两个对等连接分别配置健康检查。

1.  登录[高速通道管理控制台](https://expressconnectnext.console.aliyun.com)。 
2.  在左侧导航栏，选择**专有网络对等连接** \> **VBR上连**。
3.  单击已创建的目标对等连接**操作**列的**![更多按钮](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654309_zh-CN.png)** \> **健康检查**。
4.  在健康检查页面，单击**设置**。
5.  在修改边界路由器页面，配置健康检查信息。 具体参数说明如下：

    |参数|说明|
    |--|--|
    |源IP|互通的VPC内未被使用的任意一个私网IP地址。|
    |目标IP|本地IDC网络设备的接口IP地址。 如果需要从IDC向VPC做ICMP健康检查，建议将目标地址设置为VPC健康检查源地址，并配置指向新的健康检查目的地址的路由。

 |

    ![健康检查](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654391_zh-CN.png)

6.  单击**确定**。
7.  重复上述步骤，完成另一个对等连接的健康检查配置。 

    **说明：** 第二个对等连接的健康检查源IP不能跟第一个重复。


## 步骤二 配置路由权重 {#section_6u8_1u6_bt1 .section}

本次操作以配置负载路由为例。

1.  在左侧导航栏，单击**路由表**。
2.  单击需要配置负载路由和权重的VPC实例ID，然后单击目标路由表ID。
3.  在路由表页面，单击**添加路由条目**，配置负载路由。 根据以下信息配置负载路由：

    -   **目标网段**：要转发到的目标网段。
    -   **下一跳类型**：此处选择**路由器接口（边界路由器方向）**，表示将目的地址在目标网段范围内的流量路由至边界路由器关联的路由器接口。

        路由方式选择**负载路由**，选择VPC对接的两个边界路由器作为下一跳。实例权重的有效范围为1-255的整数，默认值为100。每个实例的权重必须相同，系统会将流量平均分配给下一跳实例。

    ![负载路由配置](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654353_zh-CN.png)

4.  继续单击**添加路由条目**，配置第一个边界路由器到本地IDC的互联地址网段的路由。 根据以下信息配置负载路由：
    -   **目标网段**：要转发到的目标网段。
    -   **下一跳类型**：此处选择**路由器接口（边界路由器方向）**，表示将目的地址在目标网段范围内的流量路由至边界路由器关联的路由器接口。

        路由方式选择**普通路由**，选择第一个边界路由器接口。

5.  继续单击**添加路由条目**，配置第二个边界路由器到本地IDC的互联地址网段的路由。 根据以下信息配置负载路由：

    -   **目标网段**：要转发到的目标网段。
    -   **下一跳类型**：此处选择**路由器接口（边界路由器方向）**，表示将目的地址在目标网段范围内的流量路由至边界路由器关联的路由器接口。

        路由方式选择**普通路由**，选择第二个边界路由器接口。

    路由配置完成后如下图所示。

    ![路由条目](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654373_zh-CN.png)


## 步骤三 本地机房CPE设备配置云上健康检查源IP的静态路由 {#section_i3z_mp0_y5r .section}

边界路由器和本地IDC之间配置的是静态路由配置，未使用BGP时，本地机房CPE设备需要配置以下静态路由：

-   本地机房CPE设备，配置到第一个对等连接健康检查源IP的下一跳为云上第一个边界路由器的IP地址（新建VBR配置的云上互联IP地址）。
-   本地机房CPE设备，配置到第二个对等连接健康检查源IP的下一跳为云上第二个边界路由器的IP地址。

## 步骤四 测试网络连通性 {#section_ghk_iuc_q03 .section}

当一条物理专线出现故障时，尝试ping云上VPC中的实例，确认是否能够通过冗余专线访问云上资源。

## 补充说明 {#section_vgs_btq_xvq .section}

若您的边界路由器和本地机房CPE配置了BGP，边界路由器对健康检查地址需要进行BGP网段的宣告。

1.  登录[高速通道管理控制台](https://expressconnectnext.console.aliyun.com)。 
2.  在左侧导航栏，选择**物理专线连接** \> **边界路由器（VBR）**。
3.  单击第一个VBR实例ID，在路由条目页签下，单击**添加路由条目**。
4.  在添加路由条目页面，配置健康检查源地址路由信息。 相关参数说明如下：

    -   **目标网段**：健康检查源IP，本次配置为192.168.10.1/32。
    -   **下一跳类型**：此处选择**专有网络**，选择对接的VPC实例。
    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654421_zh-CN.png)

5.  在宣告BGP网段页签下，单击**宣告BGP网段**。
6.  在宣告BGP网段页面，配置健康检查的源IP。 

    ![宣告BGP网段](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/1227037/156885740654424_zh-CN.png)

7.  重复上述步骤，给第二个边界路由器的健康检查地址需要进行BGP网段的宣告。

